From 3d392776b9ddd4587122e1c8ce7966600a34d206 Mon Sep 17 00:00:00 2001
From: "yi.liu" <yi.liu@amlogic.com>
Date: Wed, 15 Nov 2023 18:33:45 +0800
Subject: [PATCH 2/4] amlbian: Support upgrading uboot by install deb [1/1]

PD#SWPL-146130

Problem:
Different startup methods require support for uboot upgrade.

Solution:
Add kernel startup parameters(boot_soure),
distinguishing the startup method of Debian.

Verify:
local

Change-Id: I53ffbb50cca92ff99440912b29ffe23f9a8465d0
Signed-off-by: yi.liu <yi.liu@amlogic.com>
---
 board/amlogic/common/board.c                | 46 +++++++++++++++++++++
 board/amlogic/configs/g12a_u200_debian_v1.h | 39 +++++++++--------
 board/amlogic/configs/g12b_w400_debian_v1.h |  9 ++--
 board/amlogic/g12a_u200_v1/g12a_u200_v1.c   |  5 +++
 board/amlogic/g12b_w400_v1/g12b_w400_v1.c   | 10 ++++-
 5 files changed, 86 insertions(+), 23 deletions(-)

diff --git a/board/amlogic/common/board.c b/board/amlogic/common/board.c
index 64402d91229..fd2b69793c1 100644
--- a/board/amlogic/common/board.c
+++ b/board/amlogic/common/board.c
@@ -10,7 +10,10 @@
 #include <environment.h>
 #include <fdt_support.h>
 #include <cli.h>
+#include <asm/cpu_id.h>
 #include <generated/version_autogenerated.h>
+#include <asm/arch/secure_apb.h>
+#include <asm/arch/romboot.h>
 
 #ifdef CONFIG_MISC_INIT_R
 #define _AML_MISC_INTERRUPT_KEY 0x09
@@ -211,3 +214,46 @@ exit:
 }
 #endif
 
+static int board_get_bootid(void)
+{
+	int boot_id = 0;
+
+#if defined(P_AO_SEC_GP_CFG0)
+	boot_id = readl(P_AO_SEC_GP_CFG0) & 0xf;
+#endif// #if defined(P_AO_SEC_GP_CFG0)
+
+	return boot_id;
+}
+
+void board_set_boot_source(void)
+{
+	const char *source;
+
+	switch (board_get_bootid()) {
+	case BOOT_ID_EMMC:
+		source = "emmc";
+		break;
+
+	case BOOT_ID_NAND:
+		source = "nand";
+		break;
+
+	case BOOT_ID_SPI:
+		source = "spi";
+		break;
+
+	case BOOT_ID_SDCARD:
+		source = "sd";
+		break;
+
+	case BOOT_ID_USB:
+		source = "usb";
+		break;
+
+	default:
+		source = "unknown";
+	}
+
+	setenv("boot_source", source);
+	printf("%s, boot_source: %s\n", __func__, source);
+}
diff --git a/board/amlogic/configs/g12a_u200_debian_v1.h b/board/amlogic/configs/g12a_u200_debian_v1.h
index ecfb97dc587..c938d2e082f 100644
--- a/board/amlogic/configs/g12a_u200_debian_v1.h
+++ b/board/amlogic/configs/g12a_u200_debian_v1.h
@@ -205,7 +205,7 @@
 	"initargs="\
 		"rootflags=data=writeback rw rootfstype=ext4 console=tty0 console=ttyS0,115200 no_console_suspend " \
 		" earlycon=aml-uart,0xff803000 ramoops.pstore_en=1 ramoops.record_size=0x8000 ramoops.console_size=0x4000 "\
-		"scsi_mod.scan=async xhci_hcd.quirks=0x800000 gamma=0 boot_source=emmc "\
+		"scsi_mod.scan=async xhci_hcd.quirks=0x800000 gamma=0 "\
 		"\0"\
 	"upgrade_check="\
 		"echo upgrade_step=${upgrade_step}; "\
@@ -215,23 +215,26 @@
 		"\0"\
 	"storeargs="\
 		"get_bootloaderversion;" \
-	"setenv bootargs ${initargs} phy_idx=${phy_idx} hdr_policy=${hdr_policy} "\
-		"hdr_priority=${hdr_priority} otg_device=${otg_device} "\
-		"reboot_mode_android=${reboot_mode_android} "\
-		"logo=${display_layer},loaded,${fb_addr} "\
-		"fb_width=${fb_width} fb_height=${fb_height} display_bpp=${display_bpp} "\
-		"outputmode=${outputmode} vout2=${outputmode2},enable "\
-		"vout=${outputmode},${vout_init} "\
-		"panel_type=${panel_type} lcd_ctrl=${lcd_ctrl} lcd_debug=${lcd_debug} "\
-		"hdmitx=${cecconfig},${colorattribute} hdmimode=${hdmimode} "\
-		"hdmichecksum=${hdmichecksum} dolby_vision_on=${dolby_vision_on} "\
-		"frac_rate_policy=${frac_rate_policy} hdmi_read_edid=${hdmi_read_edid} "\
-		"cvbsmode=${cvbsmode} osd_reverse=${osd_reverse} video_reverse=${video_reverse} "\
-		"irq_check_en=${Irq_check_en} androidboot.selinux=${EnableSelinux} "\
-		"androidboot.firstboot=${firstboot} jtag=${jtag}; "\
-		"setenv bootargs ${bootargs} androidboot.hardware=amlogic androidboot.bootloader=${bootloader_version} androidboot.build.expect.baseband=N/A;"\
-				"run cmdline_keys;"\
-				"\0"\
+		"setenv bootargs ${initargs} phy_idx=${phy_idx} hdr_policy=${hdr_policy} "\
+			"hdr_priority=${hdr_priority} otg_device=${otg_device} "\
+			"reboot_mode_android=${reboot_mode_android} "\
+			"logo=${display_layer},loaded,${fb_addr} "\
+			"fb_width=${fb_width} fb_height=${fb_height} display_bpp=${display_bpp} "\
+			"outputmode=${outputmode} vout2=${outputmode2},enable "\
+			"vout=${outputmode},${vout_init} "\
+			"panel_type=${panel_type} lcd_ctrl=${lcd_ctrl} lcd_debug=${lcd_debug} "\
+			"hdmitx=${cecconfig},${colorattribute} hdmimode=${hdmimode} "\
+			"hdmichecksum=${hdmichecksum} dolby_vision_on=${dolby_vision_on} "\
+			"frac_rate_policy=${frac_rate_policy} hdmi_read_edid=${hdmi_read_edid} "\
+			"cvbsmode=${cvbsmode} osd_reverse=${osd_reverse} "\
+			"video_reverse=${video_reverse} "\
+			"irq_check_en=${Irq_check_en} androidboot.selinux=${EnableSelinux} "\
+			"androidboot.firstboot=${firstboot} jtag=${jtag}; "\
+		"setenv bootargs ${bootargs} androidboot.hardware=amlogic "\
+				"androidboot.bootloader=${bootloader_version} "\
+				"androidboot.build.expect.baseband=N/A boot_source=${boot_source};"\
+		"run cmdline_keys;"\
+		"\0"\
 	"switch_bootmode="\
 		"get_rebootmode;"\
 		"if test ${reboot_mode} = factory_reset; then "\
diff --git a/board/amlogic/configs/g12b_w400_debian_v1.h b/board/amlogic/configs/g12b_w400_debian_v1.h
index 1c731f225b4..d037a10d7c2 100644
--- a/board/amlogic/configs/g12b_w400_debian_v1.h
+++ b/board/amlogic/configs/g12b_w400_debian_v1.h
@@ -187,7 +187,7 @@
 		"initargs="\
 			"rootflags=data=writeback rw rootfstype=ext4 console=tty0 console=ttyS0,115200 no_console_suspend " \
 			" earlycon=aml-uart,0xff803000 ramoops.pstore_en=1 ramoops.record_size=0x8000 ramoops.console_size=0x4000 "\
-			"scsi_mod.scan=async xhci_hcd.quirks=0x800000 gamma=0 boot_source=emmc "\
+			"scsi_mod.scan=async xhci_hcd.quirks=0x800000 gamma=0 "\
 			"\0"\
 		"upgrade_check="\
 			"echo upgrade_step=${upgrade_step}; "\
@@ -197,7 +197,8 @@
 			"\0"\
 		"storeargs="\
 			"get_bootloaderversion;" \
-			"setenv bootargs ${initargs} hdr_policy=${hdr_policy}  hdr_priority=${hdr_priority} "\
+			"setenv bootargs ${initargs} hdr_policy=${hdr_policy} "\
+			"hdr_priority=${hdr_priority} "\
 			"otg_device=${otg_device} reboot_mode_android=${reboot_mode_android} "\
 			"logo=${display_layer},loaded,${fb_addr} "\
 			"fb_width=${fb_width} fb_height=${fb_height} display_bpp=${display_bpp} "\
@@ -210,7 +211,9 @@
 			"cvbsmode=${cvbsmode} osd_reverse=${osd_reverse} video_reverse=${video_reverse} "\
 			"irq_check_en=${Irq_check_en}  androidboot.selinux=${EnableSelinux} "\
 			"androidboot.firstboot=${firstboot} jtag=${jtag}; "\
-			"setenv bootargs ${bootargs} androidboot.hardware=amlogic androidboot.bootloader=${bootloader_version} androidboot.build.expect.baseband=N/A;"\
+			"setenv bootargs ${bootargs} androidboot.hardware=amlogic "\
+				"androidboot.bootloader=${bootloader_version} "\
+				"androidboot.build.expect.baseband=N/A boot_source=${boot_source};"\
 			"run cmdline_keys;"\
 			"\0"\
 		"switch_bootmode="\
diff --git a/board/amlogic/g12a_u200_v1/g12a_u200_v1.c b/board/amlogic/g12a_u200_v1/g12a_u200_v1.c
index d4d0c697915..f2dd0a3d1af 100644
--- a/board/amlogic/g12a_u200_v1/g12a_u200_v1.c
+++ b/board/amlogic/g12a_u200_v1/g12a_u200_v1.c
@@ -693,6 +693,7 @@ static void board_init_mem(void)
 	}
 }
 
+extern void board_set_boot_source(void);
 int board_late_init(void)
 {
 	 TE(__func__);
@@ -744,6 +745,10 @@ int board_late_init(void)
 		/* load unifykey */
 		run_command("keyunify init 0x1234", 0);
 
+#ifdef CONFIG_SM1_AC200_DEBIAN_V1
+	// Set boot source
+	board_set_boot_source();
+#endif
 		/* reset vout init state */
 		run_command("setenv vout_init disable", 0);
 
diff --git a/board/amlogic/g12b_w400_v1/g12b_w400_v1.c b/board/amlogic/g12b_w400_v1/g12b_w400_v1.c
index 30d933c3532..5ccde660346 100644
--- a/board/amlogic/g12b_w400_v1/g12b_w400_v1.c
+++ b/board/amlogic/g12b_w400_v1/g12b_w400_v1.c
@@ -667,6 +667,7 @@ int board_init(void)
 }
 
 #ifdef CONFIG_BOARD_LATE_INIT
+extern void board_set_boot_source(void);
 int board_late_init(void)
 {
 	TE(__func__);
@@ -714,8 +715,13 @@ int board_late_init(void)
 		}
 #endif// #ifndef DTB_BIND_KERNEL
 
-		/* load unifykey */
-		run_command("keyunify init 0x1234", 0);
+	/* load unifykey */
+	run_command("keyunify init 0x1234", 0);
+
+#ifdef CONFIG_G12B_W400_DEBIAN_V1
+	// Set boot source
+	board_set_boot_source();
+#endif
 
 	/* reset vout init state */
 	run_command("setenv vout_init disable", 0);
-- 
2.25.1

