From 39ff7561ea1c87c86d09951eaaa501842d6e3689 Mon Sep 17 00:00:00 2001
From: Long <long.yu@amlogic.com>
Date: Wed, 13 Dec 2023 17:15:26 +0800
Subject: [PATCH 7/7] eMMC: Use the attributes in dts to control the hw-reset.
 [1/1]

Change-Id: Iabb21c502247c4f8dd08166fc112c4df5632a7c1
Signed-off-by: Long <long.yu@amlogic.com>
---
 drivers/mmc/meson_gx_mmc.c | 3 +++
 drivers/mmc/mmc.c          | 5 ++++-
 include/mmc.h              | 1 +
 3 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/drivers/mmc/meson_gx_mmc.c b/drivers/mmc/meson_gx_mmc.c
index 2af8c56e576..8bd577f209a 100644
--- a/drivers/mmc/meson_gx_mmc.c
+++ b/drivers/mmc/meson_gx_mmc.c
@@ -1532,6 +1532,9 @@ static int meson_mmc_ofdata_to_platdata(struct udevice *dev)
 			return ret;
 	}
 
+	if (aml_card_type_mmc(host) && dev_read_bool(dev, "cap-mmc-hw-reset"))
+		pdata->mmc.enable_mmc_hw_reset = true;
+
 	clk_get_by_name(dev, "clkin", &host->div2);
 	clk_get_by_name(dev, "xtal", &host->xtal);
 	clk_get_by_name(dev, "mux", &host->mux);
diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index 3b7f279fb51..6e4c9c7592c 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -2867,9 +2867,12 @@ int mmc_start_init(struct mmc *mmc)
 
 int enable_mmc_reset(struct mmc *mmc)
 {
-	int err;
+	int err = 0;
 	u8 ext_csd[512] = {0};
 
+	if (!IS_MMC(mmc) || !mmc->enable_mmc_hw_reset)
+		return err;
+
 	memset(ext_csd, 0, 512);
 	err = mmc_get_ext_csd(mmc, ext_csd);
 	if (err)
diff --git a/include/mmc.h b/include/mmc.h
index 0edc278e8b3..bb3464ad135 100644
--- a/include/mmc.h
+++ b/include/mmc.h
@@ -700,6 +700,7 @@ struct mmc {
 				  */
 	int refix;
 	u32 quirks;
+	bool enable_mmc_hw_reset;
 };
 
 struct mmc_hwpart_conf {
-- 
2.25.1

