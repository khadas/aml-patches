From 83c12068b8cbd02341c72a354e62564f523a8aea Mon Sep 17 00:00:00 2001
From: Dezhi Kong <dezhi.kong@amlogic.com>
Date: Mon, 3 Aug 2020 16:10:50 +0800
Subject: [PATCH 1/6] gpu: optimize gpu dvfs tbl [1/1]

PD#SWPL-30505

Problem:
the fps is lower when run westeros_test

Solution:
optimize the dvfs of gpu

Verify:
Local

Change-Id: I8fdc13ea505dac211e9ffac35d38630ae139ce42
Signed-off-by: Dezhi Kong <dezhi.kong@amlogic.com>
---
 arch/arm/boot/dts/amlogic/mesong12a_drm.dtsi  | 26 ++++++++++-----
 arch/arm/boot/dts/amlogic/mesong12b_drm.dtsi  | 32 +++++++++++++++++++
 arch/arm/boot/dts/amlogic/mesonsm1_drm.dtsi   | 32 +++++++++++++++++++
 arch/arm/boot/dts/amlogic/mesontl1_drm.dtsi   | 32 +++++++++++++++++++
 arch/arm/boot/dts/amlogic/mesontm2_drm.dtsi   | 32 +++++++++++++++++++
 .../arm64/boot/dts/amlogic/mesong12a_drm.dtsi | 26 ++++++++++-----
 .../arm64/boot/dts/amlogic/mesong12b_drm.dtsi | 32 +++++++++++++++++++
 arch/arm64/boot/dts/amlogic/mesonsm1_drm.dtsi | 32 +++++++++++++++++++
 arch/arm64/boot/dts/amlogic/mesontl1_drm.dtsi | 32 +++++++++++++++++++
 arch/arm64/boot/dts/amlogic/mesontm2_drm.dtsi | 32 +++++++++++++++++++
 10 files changed, 292 insertions(+), 16 deletions(-)

diff --git a/arch/arm/boot/dts/amlogic/mesong12a_drm.dtsi b/arch/arm/boot/dts/amlogic/mesong12a_drm.dtsi
index 9d1e3f689a22..99436ac9e030 100644
--- a/arch/arm/boot/dts/amlogic/mesong12a_drm.dtsi
+++ b/arch/arm/boot/dts/amlogic/mesong12a_drm.dtsi
@@ -283,23 +283,33 @@
 };
 
 &gpu{
-	/*gpu max freq is 850M*/
 	def_clk = <1>;
-	tbl = <&dvfs285_cfg &dvfs666_cfg &dvfs850_cfg &dvfs850_cfg>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs850_cfg
+		&dvfs850_cfg>;
 
 	dvfs285_cfg:dvfs285_cfg {
-		 keep_count = <2>;
-		 threshold = <100 200>;
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
 	};
 
 	dvfs666_cfg:dvfs666_cfg {
-		 keep_count = <1>;
-		 threshold = <85 200>;
+		 threshold = <80 120>;
 	};
 
 	dvfs850_cfg:dvfs850_cfg {
-		 keep_count = <1>;
-		 threshold = <179 255>;
+		 threshold = <80 255>;
 	};
 
 };
+
diff --git a/arch/arm/boot/dts/amlogic/mesong12b_drm.dtsi b/arch/arm/boot/dts/amlogic/mesong12b_drm.dtsi
index 7a011062cffd..0e19ac10ed7a 100644
--- a/arch/arm/boot/dts/amlogic/mesong12b_drm.dtsi
+++ b/arch/arm/boot/dts/amlogic/mesong12b_drm.dtsi
@@ -280,3 +280,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm/boot/dts/amlogic/mesonsm1_drm.dtsi b/arch/arm/boot/dts/amlogic/mesonsm1_drm.dtsi
index 3ae18ba54048..9c19b8878c7d 100644
--- a/arch/arm/boot/dts/amlogic/mesonsm1_drm.dtsi
+++ b/arch/arm/boot/dts/amlogic/mesonsm1_drm.dtsi
@@ -281,3 +281,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs850_cfg
+		&dvfs850_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs850_cfg:dvfs850_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm/boot/dts/amlogic/mesontl1_drm.dtsi b/arch/arm/boot/dts/amlogic/mesontl1_drm.dtsi
index 1060aad3cf29..0974b21b52f3 100644
--- a/arch/arm/boot/dts/amlogic/mesontl1_drm.dtsi
+++ b/arch/arm/boot/dts/amlogic/mesontl1_drm.dtsi
@@ -251,3 +251,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm/boot/dts/amlogic/mesontm2_drm.dtsi b/arch/arm/boot/dts/amlogic/mesontm2_drm.dtsi
index a08af5d2e7dc..d8337e28801e 100644
--- a/arch/arm/boot/dts/amlogic/mesontm2_drm.dtsi
+++ b/arch/arm/boot/dts/amlogic/mesontm2_drm.dtsi
@@ -276,3 +276,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm64/boot/dts/amlogic/mesong12a_drm.dtsi b/arch/arm64/boot/dts/amlogic/mesong12a_drm.dtsi
index 06e1ad3cbfc2..37e04fa1f5ef 100644
--- a/arch/arm64/boot/dts/amlogic/mesong12a_drm.dtsi
+++ b/arch/arm64/boot/dts/amlogic/mesong12a_drm.dtsi
@@ -283,23 +283,33 @@
 };
 
 &gpu{
-	/*gpu max freq is 850M*/
 	def_clk = <1>;
-	tbl = <&dvfs285_cfg &dvfs666_cfg &dvfs850_cfg &dvfs850_cfg>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs850_cfg
+		&dvfs850_cfg>;
 
 	dvfs285_cfg:dvfs285_cfg {
-		 keep_count = <2>;
-		 threshold = <100 200>;
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
 	};
 
 	dvfs666_cfg:dvfs666_cfg {
-		 keep_count = <1>;
-		 threshold = <85 200>;
+		 threshold = <80 120>;
 	};
 
 	dvfs850_cfg:dvfs850_cfg {
-		 keep_count = <1>;
-		 threshold = <179 255>;
+		 threshold = <80 255>;
 	};
 
 };
+
diff --git a/arch/arm64/boot/dts/amlogic/mesong12b_drm.dtsi b/arch/arm64/boot/dts/amlogic/mesong12b_drm.dtsi
index fbdcb01b9384..41ce4a7764aa 100644
--- a/arch/arm64/boot/dts/amlogic/mesong12b_drm.dtsi
+++ b/arch/arm64/boot/dts/amlogic/mesong12b_drm.dtsi
@@ -280,3 +280,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm64/boot/dts/amlogic/mesonsm1_drm.dtsi b/arch/arm64/boot/dts/amlogic/mesonsm1_drm.dtsi
index 0da03785c866..43de163ea1fd 100644
--- a/arch/arm64/boot/dts/amlogic/mesonsm1_drm.dtsi
+++ b/arch/arm64/boot/dts/amlogic/mesonsm1_drm.dtsi
@@ -281,3 +281,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs850_cfg
+		&dvfs850_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs850_cfg:dvfs850_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm64/boot/dts/amlogic/mesontl1_drm.dtsi b/arch/arm64/boot/dts/amlogic/mesontl1_drm.dtsi
index 338f6c2c4e1c..2ca57a463c56 100644
--- a/arch/arm64/boot/dts/amlogic/mesontl1_drm.dtsi
+++ b/arch/arm64/boot/dts/amlogic/mesontl1_drm.dtsi
@@ -251,3 +251,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
diff --git a/arch/arm64/boot/dts/amlogic/mesontm2_drm.dtsi b/arch/arm64/boot/dts/amlogic/mesontm2_drm.dtsi
index 36ab12ac1ef1..5e5a8de9df3d 100644
--- a/arch/arm64/boot/dts/amlogic/mesontm2_drm.dtsi
+++ b/arch/arm64/boot/dts/amlogic/mesontm2_drm.dtsi
@@ -281,3 +281,35 @@
 		};
 	};
 };
+
+&gpu{
+	def_clk = <1>;
+	tbl =  <&dvfs285_cfg
+		&dvfs400_cfg
+		&dvfs500_cfg
+		&dvfs666_cfg
+		&dvfs800_cfg
+		&dvfs800_cfg>;
+
+	dvfs285_cfg:dvfs285_cfg {
+		 threshold = <30 120>;
+	};
+
+	dvfs400_cfg:dvfs400_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs500_cfg:dvfs500_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs666_cfg:dvfs666_cfg {
+		 threshold = <80 120>;
+	};
+
+	dvfs800_cfg:dvfs800_cfg {
+		 threshold = <80 255>;
+	};
+
+};
+
-- 
2.17.1

