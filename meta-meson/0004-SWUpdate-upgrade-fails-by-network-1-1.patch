From 20acb1eab2701234de0ff7123702e7644e6e6be8 Mon Sep 17 00:00:00 2001
From: "haotian.qu" <haotian.qu@amlogic.com>
Date: Wed, 26 Apr 2023 10:55:32 +0800
Subject: [PATCH] SWUpdate: upgrade fails by network [1/1]

PD#SWPL-121506

Problem:
Upgrade fails by network.

Solution:
Kernel 5.4 uses /proc/inand nodes to determine
emmc or nand, which no longer works in kernel 5.15

Verify:
t7c local

Signed-off-by: haotian.qu <haotian.qu@amlogic.com>
Change-Id: I7d09172adc68f74b8a8f24442578a49d97f45ac5
---
 .../web-ui-wifi/files/cgi-bin/scripts/swupdate/swupdate.sh      | 2 +-
 recipes-core/images/amlogic-yocto.bb                            | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/recipes-connectivity/web-ui-wifi/files/cgi-bin/scripts/swupdate/swupdate.sh b/recipes-connectivity/web-ui-wifi/files/cgi-bin/scripts/swupdate/swupdate.sh
index 0f8a960..a5e738a 100755
--- a/recipes-connectivity/web-ui-wifi/files/cgi-bin/scripts/swupdate/swupdate.sh
+++ b/recipes-connectivity/web-ui-wifi/files/cgi-bin/scripts/swupdate/swupdate.sh
@@ -2,7 +2,7 @@
 PATH=/bin:/sbin:/usr/bin:/usr/sbin
 
 if [ $1 == "start" ];then
-  if [ -f "/proc/inand" ]; then
+  if [ ! -f "/proc/mtd" ]; then
     swupdate --recovery -l 6 -k /etc/swupdate-public.pem -w "-r /var/www/swupdate/" > /tmp/swupdate.log &
   else
     swupdate --recovery -l 6 -k /etc/swupdate-public.pem -b "0 1 2 3 4" -w "-r /var/www/swupdate/" > /tmp/swupdate.log &
diff --git a/recipes-core/images/amlogic-yocto.bb b/recipes-core/images/amlogic-yocto.bb
index 6cae6d9..6388073 100644
--- a/recipes-core/images/amlogic-yocto.bb
+++ b/recipes-core/images/amlogic-yocto.bb
@@ -21,7 +21,7 @@ IMAGE_INSTALL += " \
     ${@bb.utils.contains('DISTRO_FEATURES', 'selinux', 'packagegroup-core-selinux auditd', '', d)} \
     ${@bb.utils.contains('DISTRO_FEATURES', 'aml-bluez-alsa', 'aml-bluez-alsa', '', d)} \
     ${@bb.utils.contains("DISTRO_FEATURES", "gst1-plugins-tsplayer", "gst1-plugins-tsplayer", "", d)} \
-    ${@bb.utils.contains('DISTRO_FEATURES', 'swupdate', 'swupdate', '', d)} \
+    ${@bb.utils.contains('DISTRO_FEATURES', 'swupdate', 'swupdate aml-bootloader-message libconfig', '', d)} \
     ${@bb.utils.contains('DISTRO_FEATURES', 'test_tools', 'test-tools', '', d)} \
     "
 
-- 
2.25.1

